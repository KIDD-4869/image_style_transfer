# 宫崎骏风格图片转换器

一个基于Python的Web应用，可以将普通图片转换为宫崎骏动画风格，结合深度学习神经网络风格迁移和计算机视觉优化算法。

## 功能特点

- 🎨 **智能风格转换**：结合神经网络风格迁移和计算机视觉优化，实现真正的动漫风格转换
- 🧠 **深度学习支持**：基于PyTorch和VGG19的神经网络风格迁移，支持宫崎骏风格参考图学习
- 🎭 **前景背景分离**：智能语义分割，对人物前景和背景采用不同的处理策略
- 🌟 **实时进度显示**：完整的进度跟踪系统，实时显示转换进度和损失值
- 📱 **响应式界面**：支持桌面和移动设备
- 💾 **一键下载**：轻松保存转换后的图片
- ⚡ **高性能处理**：支持大尺寸图片处理（最高2048px），保持原始分辨率

## 技术实现

### 核心技术
- **PyTorch**：深度学习框架，VGG19神经网络风格迁移
- **OpenCV**：图像处理和计算机视觉优化
- **PIL/Pillow**：图像处理
- **Flask**：Web框架
- **torchvision**：语义分割模型（DeepLabV3）

### 风格转换算法
1. **神经网络风格迁移**：基于VGG19的Gram矩阵特征匹配，学习宫崎骏风格特征
2. **两阶段优化策略**：小图风格收敛 + 大图内容微调，平衡风格和细节
3. **前景背景分离**：使用DeepLabV3语义分割，人物前景弱处理+背景强动漫化
4. **XDoG线稿增强**：扩展差分高斯边缘检测，添加柔和动漫线条
5. **颜色量化优化**：K-means聚类 + SLIC超像素均值化，实现动漫色块效果
6. **智能光影处理**：梦幻光影效果，避免同心环伪影

## 安装和运行

### 1. 安装依赖
```bash
pip install -r requirements.txt
```

### 2. 运行应用
```bash
# 方法1：使用启动脚本（推荐）
python run.py

# 方法2：直接运行
python app.py
```

### 3. 访问应用
应用将在浏览器中自动打开，或手动访问：http://localhost:5003

## 使用说明

1. **上传图片**：点击上传区域或拖拽图片文件
2. **选择参数**：
   - **风格强度**：调节动漫化程度（0.5-2.0，默认1.0）
   - **神经网络模式**：启用深度学习风格迁移（推荐开启）
3. **开始转换**：点击"开始转换"按钮，实时查看进度
4. **查看结果**：对比原图和转换后的效果
5. **下载保存**：点击"下载结果"保存高质量JPEG图片

## 高级功能

### 自定义风格参考
- 在项目根目录创建 `ghibli_images/` 文件夹
- 放入宫崎骏风格参考图片（建议5-20张）
- 系统将自动学习参考图的风格特征，提升转换效果

### 处理参数调节
- **风格强度**：数值越大，动漫化效果越强
- **神经网络模式**：开启后使用深度学习，效果更接近宫崎骏风格
- **处理时间**：根据图片大小和复杂度，预计30-60秒

## 支持格式

- **输入格式**：JPG、PNG、BMP、GIF等常见图片格式
- **文件大小**：最大16MB
- **输出格式**：JPEG（高质量95%压缩）
- **最大尺寸**：支持最高2048px尺寸图片，保持原始分辨率

## 项目结构

```
image_style_transfer/
├── run.py              # 启动脚本（主入口）
├── app.py              # Flask应用主文件
├── requirements.txt    # 依赖包列表
├── config/             # 配置文件
│   ├── __init__.py
│   └── settings.py
├── core/               # 核心功能模块
│   ├── __init__.py
│   └── real_ghibli_transfer.py  # 宫崎骏风格转换核心算法
├── utils/              # 工具模块
│   ├── __init__.py
│   └── image_utils.py
├── templates/          # 网页模板
│   └── index.html
├── static/             # 静态文件
│   └── uploads/        # 上传文件目录
└── ghibli_images/     # 宫崎骏风格参考图片
```

## 技术架构

### 核心处理流程
1. **图像预处理**：尺寸优化（保持宽高比，最大2048px），格式标准化
2. **神经网络风格迁移**（可选）：
   - 使用VGG19提取Gram矩阵风格特征
   - 两阶段优化：小图风格收敛 + 大图内容微调
   - 支持宫崎骏风格参考图学习
3. **计算机视觉优化**：
   - 前景背景分离（DeepLabV3语义分割）
   - 背景强动漫化：颜色量化 + 边缘增强
   - 前景弱处理：保留细节 + 柔和线稿
   - XDoG线稿叠加，增强动漫感
4. **后处理优化**：
   - 智能锐化增强细节
   - 色彩平衡和光影优化
   - 保持原始分辨率输出

### 系统特性
- **异步处理**：Flask后台任务，支持大文件处理
- **进度跟踪**：实时显示转换进度和损失值
- **错误恢复**：自动降级到传统方法，保证服务可用性
- **资源优化**：GPU加速（如可用），内存高效管理

### 未来扩展
- 支持更多动画风格（新海诚、迪士尼、皮克斯等）
- 实时视频风格转换
- 批量处理功能
- 高级参数自定义调节界面
- 云端部署和API服务

## 注意事项

- 首次运行需要下载依赖包，请确保网络连接
- 处理大图片可能需要较长时间
- 建议使用Chrome、Firefox等现代浏览器

## 许可证

MIT License

---

**享受创造宫崎骏风格图片的乐趣！** 🎨✨